<!DOCTYPE html>
<html>
  <head>
    <title>Performance Tuning</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="lib/default.css"/>
  </head>
  <body>
    <textarea id="source">

name: center
layout: true
class: center, middle
.footer[![:scale 5em](design-assets/Basho-Logos/svg/basho-logo-color-horiz.svg) &copy; Basho Technologies 2015]

---

name: standard
layout: true
class: left, top
.footer[![:scale 5em](design-assets/Basho-Logos/svg/basho-logo-color-horiz.svg) &copy; Basho Technologies 2015]

---

template: center

# Performance Tuning

--

# Docs website

[http://docs.basho.com/](http://docs.basho.com/)

---

# System Configuration and Tuning

1. Storage and File System Tuning
1. Kernel and Network Tuning
1. Optional I/O Settings
1. Open Files Limit
1. Other Tuning Docs

???

Show output of riak-admin diag disk i/o from cfq (completely fair queueing) to noop or deadline 

---

# Virtual Memory

Due to the heavily I/O-focused profile of Riak, swap usage can result in the entire server becoming unresponsive. 

```ini
vm.swappiness = 0
```

or

```ini
vm.swappiness = 1
```


???
We recommend setting vm.swappiness to `0` in `/etc/sysctl.conf` to prevent swapping as much as possible.  

Caveat is newer kernels propose setting this to 1 not 0, e.g. `vm.swappiness = 1`.  

Riak will complain in `riak-admin diag` about a setting of `1`.

Disabling swap will allow Riak to crash in situations where it runs out of memory. This will leave a crash dump file, named `erl_crash.dump`, in the `/var/log/riak` directory which can be used to determine the cause of the memory usage.

---

# Mounts

It is important that you mount volumes that Riak will be using for data storage with the noatime flag.

```bash
mount -o remount,noatime <riak_data_volume>
```

The `noatime` can be set in `/etc/fstab` to mount permanently.

---

# Schedulers

The default I/O scheduler (elevator) on Linux is completely fair queuing or `cfq`.

Scheduler recommendations:

* The `noop` scheduler when deploying on network-based file systems, iSCSI over HBAs, or any hardware-based RAID.
* The `deadline` scheduler when using SSD-based storage.

```bash
cat /sys/block/sda/queue/scheduler # where sda is block device
noop [deadline] cfq
```

Schedule depth recommendations:

```bash
cat /sys/block/sda/queue/nr_requests
1024
```

???
* Scheduler defines the algorithm by which data is flushed to disk.      
* Noop tends to work best with network-based file systems since they implement their own flush algorithm     
* Deadline works best for direct attached storage     
* The default scheduler is CFQ and tends to be _very_ bad for Riak performance 
* `nr_requests` defines the depth of the scheduler queue.  Default is 128.  
* Longer queues allow for more efficient ordering and increased probability of merging requests.

---

# Filesystem

* EXT4: `noatime, nodirtime, barrier = 0, data=writeback`
* XFS: `noatime, nodirtime, nobarrier, logbufs=8, logbsize=32k, allocsize=2M`

???
* Both Riak backends are append-only and can tolerate end of file corruption.  
* It is preferable to optimize for long-term throughput than for crash-time consistency. 
* Riak does not require atime, disable it 
* Barriers ensure proper write ordering by forcing a flush to media for any given commit before the next flush may begin.  
* Not necessary when using modern RAID controllers, external storage, or for Riak in general. 
* Data=writeback allows data to be flushed to disk AFTER its metadata is committed to the journal.  
* This is an optimization that favors throughput over consistency. 
* Logbufs specifies the number of in-memory log buffers. Increasing this value will generally improve performance at the cost of greater memory consumption 8 is the max 
* Logbsize specifies the log buffer size for each log buffer. Default is 32k.  
* Increasing this value will allow more file modifications to be kept in memory, improving performance Allocsize specifies how much space will be pre-allocated for files in order to reduce fragmentation 

---

# Kernel and Network Tuning

The following settings are minimally sufficient to improve many aspects of Riak usage on Linux, and should be added or updated in `/etc/sysctl.conf`:

```ini
net.ipv4.tcp_max_syn_backlog = 40000
net.core.somaxconn = 40000
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_moderate_rcvbuf = 1
```

???
Lets examine these settings one at a time

---

# In more detail...

`tcp_max_syn_backlog`

* Keeps more SYN requests in memory.  
* Helps moderate the effect of a large number of connections at peak times. 

--

`net.core.somaxconn`

* Increases the max TCP sockets in a LISTEN state.

--

`net.core.wmem_default` and `net.core.rmem_default`

---

# In more detail...

`tcp_sack` 

* Enables selective ACKs.  
* Helps to reduce the amount of data sent during retransmits. 

--

`tcp_window_scaling`

* Enables window scaling.  
* Reduces bandwidth loss on high bandwidth connections. 

--

`tcp_fin_timeout` 

* How long to keep sockets in the `FIN_WAIT_2` status. Default: 60.  
* Decreasing helps reap closed connections faster. 

---

# In more detail...

`tcp_keepalive_intvl`

* The interval between sending keepalive probes. Default: 75.
* Decreasing allows failed connections to be closed sooner. 

--

`tcp_tw_reuse`

* Allow reusing sockets in `TIME_WAIT` state for new connections.

--

`tcp_moderate_rcvbuf`

---

# Optional I/O Settings

```ini
vm.dirty_background_ratio = 0
vm.dirty_background_bytes = 209715200
vm.dirty_ratio = 40
vm.dirty_bytes = 0
vm.dirty_writeback_centisecs = 100
vm.dirty_expire_centisecs = 200
```

???

If your cluster is experiencing excessive I/O blocking, the following settings may help prevent disks from being overwhelmed during periods of high write activity at the expense of peak performance for spiky workloads.

---

# Open Files Limit

Typically need to increase `ulimit` by editing `/etc/security/limits.conf`.

```ini
riak soft nofile 4096
riak hard nofile 65536
```

???

* restart machine to take effect

---

# Other Tuning Guides

* [AWS Performance Tuning](http://docs.basho.com/riak/latest/ops/tuning/aws/)
* [Erlang VM Tuning](http://docs.basho.com/riak/latest/ops/tuning/erlang/)
* [Latency Reduction](http://docs.basho.com/riak/latest/ops/tuning/latency-reduction/)

    </textarea>
    <script src="lib/remark.js" type="text/javascript">
    </script>
	<script type="text/javascript">
        remark.macros.scale = function (percentage) {
          var url = this;
          return '<img src="' + url + '" style="width: ' + percentage + '" />';
          // Usage:
          //   ![:scale 50%](image.jpg)
          // Outputs:
          //   <img src="image.jpg" style="width: 50%" />
        };
	</script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
